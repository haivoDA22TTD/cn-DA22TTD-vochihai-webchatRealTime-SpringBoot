<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
</head>
<body>
  <div class="wrapper">
    <div class="header">
      <div class="header-account">
        <div class="online">
          <app-avatar 
            [width]="'48px'" 
            [isOnline]="true" 
            [username]="currentUser.username" 
            [avatarUrl]="currentUser.avatarUrl"
            [isAllowUpload]="true">
          </app-avatar>
        </div>
        <div class="header-username">{{currentUser.username}}</div>
        
        <span (click)="isShowDialogChat = true" class="material-symbols-rounded">add_circle</span>
      </div>
      <div class="header-title">
        {{selectedMessageRoom | messageRoomName}}
        <span class="header-title-small">{{userService.getRoomStatus(selectedMessageRoom)}}</span>
      </div>
      <div (click)="logout()" class="header-setting">
        <span class="material-symbols-rounded">logout</span>
        <span class="header-logout">ƒêƒÉng xu·∫•t</span>
      </div>
    </div>
  
    <div class="container">
      
      <div class="conversation-area">
        
        <app-active-users-list
          [currentUser]="currentUser">
        </app-active-users-list>
        
        
        <app-conversations-list 
          [messageRooms]="messageRooms"
          [currentUser]="currentUser"
          [selectedMessageRoomId]="selectedMessageRoom.id"
          (selectRoom)="selectMessageRoom($event)">
        </app-conversations-list>
      </div>
    
      
      <div class="chat-area" id="chat-area" [style.backgroundImage]="selectedMessageRoom.backgroundUrl ? 'url(' + selectedMessageRoom.backgroundUrl + ')' : 'none'" [class.has-background]="selectedMessageRoom.backgroundUrl">
        <app-message-contents-list 
          [selectedMessageRoom]="selectedMessageRoom"
          [currentUser]="currentUser"
          style="flex-grow: 1;">
        </app-message-contents-list>
        <div style="text-align: center;">
          <span class="material-symbols-rounded">arrow_upward</span>
        </div>
        
        <!-- Image preview -->
        <div *ngIf="imagePreview" class="image-preview-container" style="padding: 10px; background: var(--surface-ground); border-top: 1px solid var(--surface-border);">
          <div style="position: relative; display: inline-block;">
            <img [src]="imagePreview" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;" />
            <button (click)="removeSelectedImage()" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;">√ó</button>
          </div>
        </div>

        <form class="chat-footer">
          <div class="other-list">
            <div class="emoji">
              <span class="material-symbols-rounded" (click)="emojiPanel.toggle($event)" pTooltip="Ch·ªçn emoji">mood</span>
              <p-overlayPanel #emojiPanel [style]="{width: '320px'}">
                <div class="emoji-picker">
                  <span *ngFor="let emoji of emojis" 
                        class="emoji-item" 
                        (click)="addEmoji(emoji)">{{emoji}}</span>
                </div>
              </p-overlayPanel>
            </div>
            <div class="image-upload">
              <input type="file" id="image-input" accept="image/*" (change)="onImageSelected($event)" style="display: none;" />
              <label for="image-input" style="cursor: pointer; display: flex; align-items: center;" pTooltip="G·ª≠i ·∫£nh">
                <span class="material-symbols-rounded">image</span>
              </label>
            </div>
            <div class="file-upload">
              <input type="file" id="file-input" (change)="onFileSelected($event)" style="display: none;" />
              <label for="file-input" style="cursor: pointer; display: flex; align-items: center;" pTooltip="G·ª≠i file (.docx, .pdf, .xlsx, .zip, .rar)">
                <span class="material-symbols-rounded">attach_file</span>
              </label>
            </div>
            <div class="location-send">
              <span class="material-symbols-rounded" 
                    (click)="sendLocation()" 
                    [class.loading]="isGettingLocation"
                    pTooltip="G·ª≠i v·ªã tr√≠">
                {{isGettingLocation ? 'hourglass_empty' : 'location_on'}}
              </span>
            </div>
          </div>
          <input [(ngModel)]="messageToSend.content" 
            (keydown.enter)="sendMessage()"
            type="text" class="p-inputtext" id="message-input" placeholder="So·∫°n tin nh·∫Øn" name="content" autofocus [disabled]="isSpamBlocked"
            style="background-color: transparent;"/>
          <span (click)="sendMessage()" class="send-button material-symbols-rounded" [class.disabled]="isSpamBlocked">Send</span>
        </form>
      </div>
    
      
      <div class="detail-area">
        <ng-container *ngIf="selectedMessageRoom.id">
          <div class="detail-header">
            <ng-container *ngIf="!selectedMessageRoom.isGroup">
              <ng-container *ngFor="let member of selectedMessageRoom.members">
                <app-avatar *ngIf="member.username !== currentUser.username"
                  [username]="member.username"
                  [width]="'44px'">
                </app-avatar>
              </ng-container>
            </ng-container>
            <div *ngIf="selectedMessageRoom.isGroup">
              <img style="width: 44px; height: 44px; object-fit: cover; border-radius: 50%;"
                src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQNL_ZnOTpXSvhf1UaK7beHey2BX42U6solRA&s" alt="">
            </div>

            <div class="detail-title">
              <div class="detail-group-name">{{selectedMessageRoom | messageRoomName}}</div>
              <span *ngIf="selectedMessageRoom.isGroup && selectedMessageRoom.isAdmin" 
                    class="pi pi-pen-to-square cursor-pointer" 
                    (click)="openRenameDialog()"
                    pTooltip="ƒê·ªïi t√™n nh√≥m"></span>
            </div>
            <span class="detail-subtitle">T·∫°o b·ªüi {{selectedMessageRoom.createdById}}, {{selectedMessageRoom.createdDate | date : 'HH:mm:ss dd/MM/yyyy'}}</span>
          </div>
    
          <div class="theme">
            <div class="theme-mode">
              <p>S√°ng v√† t·ªëi</p>
              <p-inputSwitch [(ngModel)]="themeMode" (onChange)="switchMode(themeMode ? 'dark' : 'light')"/>
            </div>
            <div class="theme-color">
              <p>M√†u ch·ªß ƒë·ªÅ</p>
              <p-dropdown 
                [ngModel]="themeColor" 
                (ngModelChange)="onThemeColorChange($event)" 
                [options]="themeColors" 
                optionLabel="name"
                [style]="{'width': '100%'}">
                <ng-template pTemplate="selectedItem">
                  <div class="theme-button" [style.backgroundColor]="themeColor?.color"></div>
                </ng-template>
                <ng-template pTemplate="item" let-theme>
                  <div class="theme-button" [style.backgroundColor]="theme.color"></div>
                </ng-template>
              </p-dropdown>
            </div>
            <div class="theme-background">
              <p>·∫¢nh n·ªÅn cu·ªôc tr√≤ chuy·ªán</p>
              <div class="background-upload-section">
                <!-- N√∫t ch·ªçn ·∫£nh t·ª´ thi·∫øt b·ªã -->
                <input type="file" 
                       id="background-input" 
                       accept="image/*" 
                       (change)="onBackgroundSelected($event)" 
                       style="display: none;" />
                <label for="background-input" class="background-upload-btn" [class.uploading]="isUploadingBackground">
                  <span class="material-symbols-rounded">{{isUploadingBackground ? 'hourglass_empty' : 'add_photo_alternate'}}</span>
                  <span>{{isUploadingBackground ? 'ƒêang t·∫£i...' : 'Ch·ªçn ·∫£nh t·ª´ thi·∫øt b·ªã'}}</span>
                </label>
                
                <!-- Preview ·∫£nh n·ªÅn hi·ªán t·∫°i -->
                <div class="background-preview" *ngIf="selectedMessageRoom.backgroundUrl">
                  <img [src]="selectedMessageRoom.backgroundUrl" alt="Background preview" />
                  <button class="remove-background-btn" (click)="removeBackground()" pTooltip="X√≥a ·∫£nh n·ªÅn">
                    <span class="material-symbols-rounded">delete</span>
                  </button>
                </div>
                
                <!-- N√∫t x√≥a ·∫£nh n·ªÅn n·∫øu c√≥ -->
                <button *ngIf="selectedMessageRoom.backgroundUrl" 
                        class="clear-background-btn" 
                        (click)="removeBackground()">
                  <span class="material-symbols-rounded">block</span>
                  <span>X√≥a ·∫£nh n·ªÅn</span>
                </button>
              </div>
            </div>
          </div>
      
          <div class="detail-members">
            <div class="detail-members-header" *ngIf="selectedMessageRoom.isGroup">
              <div class="detail-member-title">Th√†nh vi√™n</div>
              <span *ngIf="selectedMessageRoom.isAdmin" (click)="isShowDialogAddMember = true" class="detail-member-add">Th√™m th√†nh vi√™n</span>
            </div>
            <!-- Hi·ªÉn th·ªã avatar c√°c th√†nh vi√™n d·∫°ng grid -->
            <div class="members-avatar-grid" *ngIf="selectedMessageRoom.isGroup">
              <div class="member-avatar-item" *ngFor="let member of selectedMessageRoom.members" [pTooltip]="member.username">
                <app-avatar
                  [username]="member.username"
                  [avatarUrl]="member.avatarUrl"
                  [width]="'40px'">
                </app-avatar>
                <span class="member-admin-badge" *ngIf="member.isAdmin">üëë</span>
              </div>
            </div>

            <div class="detail-members-list" *ngIf="selectedMessageRoom.isGroup">
              <div class="detail-member"
                *ngFor="let member of selectedMessageRoom.members">
                <app-avatar
                  [username]="member.username"
                  [avatarUrl]="member.avatarUrl"
                  [width]="'44px'">
                </app-avatar>
                <div class="detail-member-detail">
                  <div class="detail-member-username">{{member.username}}</div>
                  <span class="detail-member-subtitle">{{member.isAdmin ? 'Admin' : ''}}</span>
                </div>
                <span *ngIf="selectedMessageRoom.isAdmin && member.username != currentUser.username" (click)="selectedMember = member; isShowEditMember = true" class="material-symbols-rounded">more_vert</span>
              </div>
            </div>
          </div>
    
          <div class="leave-group">
            <p (click)="leaveGroup()">
              <span class="material-symbols-rounded">logout</span>
              r·ªùi nh√≥m
            </p>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</body>
</html>



<app-select-users-dialog
  [visible]="isShowDialogChat"
  [currentUsername]="currentUser.username"
  (onHideEvent)="isShowDialogChat = false"
  (onSubmitEvent)="chat($event)">
</app-select-users-dialog>



<app-select-users-dialog
  [visible]="isShowDialogAddMember"
  [title]="'Th√™m th√†nh vi√™n'"
  [btnAction]="'Th√™m'"
  [excludeMembers]="selectedMessageRoom.members"
  [currentUsername]="currentUser.username"
  (onHideEvent)="isShowDialogChat = false"
  (onSubmitEvent)="addMembers($event)">
</app-select-users-dialog>



<p-dialog
  [(visible)]="isShowEditMember"
  (onHide)="selectedMember = undefined"
  [showHeader]="false"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{ width: '30rem', maxWidth: '90%'}"
  class="edit-member-dialog">
  <button *ngIf="!selectedMember?.isAdmin" (click)="makeAdmin()">Trao quy·ªÅn admin</button>
  <button *ngIf="selectedMember?.isAdmin" (click)="removeAdmin()">X√≥a quy·ªÅn admin</button>
  <button (click)="removeFromGroup()">X√≥a th√†nh vi√™n kh·ªèi nh√≥m</button>
  <button (click)="isShowEditMember = false">H·ªßy</button>
</p-dialog>


<!-- Dialog ƒë·ªïi t√™n nh√≥m -->
<p-dialog
  [(visible)]="isShowRenameDialog"
  header="ƒê·ªïi t√™n nh√≥m"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{ width: '400px', maxWidth: '90%'}">
  <div class="rename-dialog-content">
    <input type="text" 
           class="p-inputtext" 
           [(ngModel)]="newGroupName" 
           placeholder="Nh·∫≠p t√™n nh√≥m m·ªõi"
           (keydown.enter)="renameGroup()"
           style="width: 100%; margin-bottom: 1rem;" />
    <div class="rename-dialog-actions">
      <button pButton label="H·ªßy" class="p-button-text" (click)="isShowRenameDialog = false"></button>
      <button pButton label="L∆∞u" (click)="renameGroup()" [disabled]="!newGroupName.trim()"></button>
    </div>
  </div>
</p-dialog>

<!-- Dialog c·∫£nh b√°o l·ªói upload file/·∫£nh -->
<p-dialog
  [(visible)]="isShowFileErrorDialog"
  [showHeader]="false"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{ width: '420px', maxWidth: '90%'}">
  <div class="error-dialog">
    <div class="error-dialog-icon">
      <span class="material-symbols-rounded" style="font-size: 64px; color: #dc3545;">cancel</span>
    </div>
    <div class="error-dialog-title">L·ªói t·∫£i l√™n</div>
    <div class="error-dialog-message">{{fileErrorMessage}}</div>
    <div class="error-dialog-actions">
      <button pButton label="ƒê√≥ng" (click)="isShowFileErrorDialog = false"></button>
    </div>
  </div>
</p-dialog>

<!-- Dialog c·∫£nh b√°o spam tin nh·∫Øn -->
<p-dialog
  [(visible)]="isShowSpamDialog"
  [showHeader]="false"
  [modal]="true"
  [dismissableMask]="true"
  [closable]="false"
  [style]="{ width: '420px', maxWidth: '90%'}">
  <div class="error-dialog spam-dialog">
    <div class="error-dialog-icon">
      <span class="material-symbols-rounded" style="font-size: 64px; color: #f59e0b;">warning</span>
    </div>
    <div class="error-dialog-title" style="color: #f59e0b;">Gi·ªõi h·∫°n g·ª≠i tin nh·∫Øn</div>
    <div class="error-dialog-message">
      B·∫°n ƒë√£ ƒë·∫°t gi·ªõi h·∫°n g·ª≠i tin nh·∫Øn.<br><br>
      Vui l√≤ng ƒë·ª£i <strong>1 ph√∫t</strong> cho l·∫ßn g·ª≠i ti·∫øp theo.
    </div>
    <div class="error-dialog-actions">
      <button pButton label="ƒê√£ hi·ªÉu" class="p-button-warning" (click)="clearSpamError()"></button>
    </div>
  </div>
</p-dialog>

<!-- Dialog l·ªói v·ªã tr√≠ GPS -->
<p-dialog
  [(visible)]="isShowLocationErrorDialog"
  [showHeader]="false"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{ width: '420px', maxWidth: '90%'}">
  <div class="error-dialog location-dialog">
    <div class="error-dialog-icon">
      <span class="material-symbols-rounded" style="font-size: 64px; color: #f59e0b;">location_off</span>
    </div>
    <div class="error-dialog-title" style="color: #f59e0b;">Kh√¥ng th·ªÉ truy c·∫≠p v·ªã tr√≠</div>
    <div class="error-dialog-message">{{locationErrorMessage}}</div>
    <div class="error-dialog-actions">
      <button pButton label="ƒê√≥ng" class="p-button-warning" (click)="isShowLocationErrorDialog = false"></button>
    </div>
  </div>
</p-dialog>